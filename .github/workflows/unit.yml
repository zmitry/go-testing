# NOTE: this file is auto-generated by update-build-scripts.sh from go-test-workflow.tmpl.yaml
# NOTE: please do not edit this file directly

# NOTE: if you need to add images or charts to build, see artifacts.yaml
name: Go unit test for backend
on:
  pull_request:
  merge_group:
    types: [checks_requested]

permissions:
  actions: read
  checks: read
  contents: read
  deployments: read
  statuses: read
  id-token: write
  issues: read
  packages: read
  pull-requests: write

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Switch to Go 1.21.8
        uses: actions/setup-go@v1
        with:
          go-version: "1.21.8"
      - name: Test
        working-directory: backend
        # only run 1 package at a time for integration tests to allow reusing testcontainers
        run: go test -v -covermode=atomic -coverprofile=cover.out   ./...
      - name: Generate coverage report
        working-directory: backend
        run: go tool cover -html=cover.out -o cover.html
      - name: "Archive code coverage results"
        uses: "actions/upload-artifact@v4"
        with:
          name: "coverage-unit"
          path: "backend/cover.out"
  test2:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Switch to Go 1.21.8
        uses: actions/setup-go@v1
        with:
          go-version: "1.21.8"
      - name: Test
        working-directory: backend
        # only run 1 package at a time for integration tests to allow reusing testcontainers
        run: go test -v -covermode=atomic -coverprofile=cover.out   ./...

      - name: "Archive code coverage results"
        uses: "actions/upload-artifact@v4"
        with:
          name: "coverage-backend"
          path: "backend/cover.out"
  coverage:
    name: Coverage
    needs: [test, test2]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: backend/coverage
      - name: Switch to Go 1.21.8
        uses: actions/setup-go@v1
        with:
          go-version: "1.21.8"
      - name: "Merge coverage reports"
        working-directory: backend
        run: |
          coverage=$(ls coverage)
          ls coverage
          go install github.com/shabbyrobe/gocovmerge/cmd/gocovmerge@latest                  
          echo "mode: atomic" > merged.out
          for c in $coverage; do
            cat "coverage/$c/cover.out"
            ~/go/bin/gocovmerge merged.out coverage/$c/cover.out > tmp.out
            cat tmp.out > merged.out
          done
      - name: convert to lcov
        run: |
            cat merged.out
            # cat merged2.out
            go install github.com/jandelgado/gcov2lcov@latest
            GOROOT=$(go env GOROOT)  ~/go/bin/gcov2lcov -infile=merged.out -outfile=lcov.info
            go tool cover -html=merged.out -o cover.html
        working-directory: backend
      - uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          title: Backend code coverage
          lcov-file: backend/lcov.info
          delete-old-comments: true
          filter-changed-files: true
      - name: "Archive code coverage results"
        uses: "actions/upload-artifact@v4"
        with:
          name: "merged-coverage"
          path: "backend/lcov.info"
      - name: "Archive code coverage results html"
        uses: "actions/upload-artifact@v4"
        with:
          name: "merged-coverage-html"
          path: "backend/cover.html"

      - name: "Archive code coverage results gcov"
        uses: "actions/upload-artifact@v4"
        with:
          name: "merged-coverage-html"
          path: "backend/merged.out"
