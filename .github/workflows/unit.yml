# NOTE: this file is auto-generated by update-build-scripts.sh from go-test-workflow.tmpl.yaml
# NOTE: please do not edit this file directly

# NOTE: if you need to add images or charts to build, see artifacts.yaml
name: Go unit test for backend
on:
  pull_request:
  merge_group:
    types: [checks_requested]

permissions:
  actions: read
  checks: read
  contents: read
  deployments: read
  statuses: read
  id-token: write
  issues: read
  packages: read
  pull-requests: write

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Switch to Go 1.21.8
        uses: actions/setup-go@v1
        with:
          go-version: "1.21.8"
      - name: Test
        # only run 1 package at a time for integration tests to allow reusing testcontainers
        run: go test -v -covermode=atomic -coverprofile=cover.out   ./...
      - name: Generate coverage report
        run: go tool cover -html=cover.out -o cover.html
      - name: "Archive code coverage results"
        uses: "actions/upload-artifact@v4"
        with:
          name: "coverage-unit"
          path: "cover.out"
  coverage:
    name: Coverage
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage
      - name: Switch to Go 1.21.8
        uses: actions/setup-go@v1
        with:
          go-version: "1.21.8"
      - name: "Merge coverage reports"
        run: |
          coverage=$(ls coverage)
          echo "mode: atomic" > merged.out
          for c in $coverage; do
            tail -q -n +2 coverage/$coverage/cover.out >> merged.out
          done
      - name: "Archive code coverage results"
        uses: "actions/upload-artifact@v4"
        with:
          name: "code-coverage"
          path: "merged.out"
      - run: | 
          cat merged.out
          # cat merged2.out
          go install github.com/jandelgado/gcov2lcov@latest && GOROOT=$(go env GOROOT)  ~/go/bin/gcov2lcov -infile=merged.out -outfile=merged.lcov
          cat merged.lcov
      - uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: merged.lcov
          delete-old-comments: true
          filter-changed-files: true

